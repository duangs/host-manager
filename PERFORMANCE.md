# 性能优化说明

本文档详细说明了 Hosts Manager 应用的性能优化措施和最佳实践。

## 优化概述

### 1. Electron 主进程优化

#### 硬件加速
- 启用 GPU 光栅化 (`--enable-gpu-rasterization`)
- 启用零拷贝 (`--enable-zero-copy`)
- 忽略 GPU 黑名单 (`--ignore-gpu-blacklist`)
- 启用 Vaapi 视频解码器 (`--enable-features=VaapiVideoDecoder`)

#### 内存管理
- 禁用背景定时器节流 (`--disable-background-timer-throttling`)
- 禁用渲染器后台化 (`--disable-renderer-backgrounding`)
- 禁用窗口后台化 (`--disable-backgrounding-occluded-windows`)
- 定期内存清理（每30秒）

#### 文件操作优化
- 实现文件内容缓存机制
- 带重试的文件读写操作
- 文件大小验证（最大1MB）
- 文件变化监控

### 2. 渲染进程优化

#### 渲染配置
```typescript
webPreferences: {
  hardwareAcceleration: true,
  backgroundThrottling: false,
  webgl: true,
  webSecurity: true,
  enableRemoteModule: false
}
```

#### 性能监控
- API 调用时间监控
- 错误率统计
- 内存使用监控
- 慢调用检测

### 3. 缓存策略

#### 文件缓存
- 缓存 hosts 文件内容
- 缓存过期时间：5秒
- 最大缓存大小：1MB
- 智能缓存更新

#### 性能指标缓存
- 保留最近100次API调用记录
- 自动清理过期数据
- 实时性能统计

## 性能监控

### 监控指标

1. **API调用次数** - 记录所有IPC调用的次数
2. **平均响应时间** - 计算API调用的平均耗时
3. **错误率** - 统计API调用的失败率
4. **运行时间** - 应用启动后的运行时长
5. **缓存大小** - 当前缓存的数据大小
6. **窗口数量** - 当前打开的窗口数量

### 监控界面

应用内置了性能监控组件，可以实时查看：
- 性能指标面板
- 内存使用情况
- 缓存状态
- 错误统计

## 优化配置

### 性能配置常量

```typescript
const PERFORMANCE_CONFIG = {
  CACHE: {
    EXPIRE_TIME: 5000,        // 缓存过期时间
    MAX_SIZE: 1024 * 1024,    // 最大缓存大小
    CLEANUP_INTERVAL: 30000   // 清理间隔
  },
  FILE: {
    MAX_SIZE: 1024 * 1024,    // 最大文件大小
    MAX_RETRIES: 3,           // 重试次数
    RETRY_DELAY: 1000,        // 重试延迟
    WATCH_INTERVAL: 1000      // 监控间隔
  },
  MEMORY: {
    GC_INTERVAL: 30000,       // 内存清理间隔
    WARNING_THRESHOLD: 512,   // 内存警告阈值
    CLEANUP_THRESHOLD: 256    // 清理阈值
  }
}
```

### 平台特定优化

#### Windows
- 启用 DirectX 硬件加速
- 优化文件系统访问
- 内存管理优化

#### macOS
- 启用 Metal 硬件加速
- 优化文件监控
- 内存压缩支持

#### Linux
- 启用 OpenGL 硬件加速
- 优化文件系统监控
- 内存管理优化

## 最佳实践

### 1. 文件操作
- 使用带重试的文件读写
- 验证文件大小和权限
- 实现文件变化监控
- 缓存文件内容

### 2. 内存管理
- 定期清理内存
- 监控内存使用
- 及时释放资源
- 避免内存泄漏

### 3. 错误处理
- 实现重试机制
- 记录错误日志
- 优雅降级
- 用户友好提示

### 4. 性能监控
- 实时监控关键指标
- 记录性能数据
- 分析性能瓶颈
- 持续优化

## 性能测试

### 测试环境
- Windows 10/11
- macOS 10.15+
- Ubuntu 20.04+

### 测试指标
- 启动时间：< 3秒
- 文件读取：< 100ms
- 文件写入：< 200ms
- 内存使用：< 100MB
- CPU使用：< 5%

### 测试方法
1. 使用性能监控组件观察指标
2. 进行大量文件操作测试
3. 长时间运行稳定性测试
4. 内存泄漏检测

## 故障排除

### 常见问题

1. **启动缓慢**
   - 检查硬件加速是否启用
   - 验证GPU驱动是否最新
   - 检查系统资源使用情况

2. **内存使用过高**
   - 启用内存监控
   - 检查内存泄漏
   - 调整清理阈值

3. **文件操作失败**
   - 检查文件权限
   - 验证文件路径
   - 查看错误日志

4. **性能下降**
   - 监控性能指标
   - 分析慢调用
   - 优化缓存策略

### 调试工具

1. **开发者工具**
   - 使用 Chrome DevTools
   - 查看控制台日志
   - 分析网络请求

2. **性能分析**
   - 使用性能监控组件
   - 分析内存使用
   - 监控API调用

3. **日志分析**
   - 查看应用日志
   - 分析错误信息
   - 追踪性能问题

## 持续优化

### 优化策略
1. 定期性能评估
2. 用户反馈收集
3. 新技术应用
4. 代码重构优化

### 监控指标
1. 用户使用情况
2. 性能指标趋势
3. 错误率变化
4. 资源使用情况

### 更新计划
1. 定期更新依赖
2. 应用最新优化技术
3. 修复性能问题
4. 添加新功能优化 